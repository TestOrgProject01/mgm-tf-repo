#ms-dynamics repo scanning with Xray
name: Jfrog Xray audit

on:
  push:
    branches:
    - main
env:
  JF_URL: https://mgmresorts.jfrog.io
  JFROG_USERNAME: 'arana@mgmresorts.com'
  JFROG_CLI_LOG_LEVEL: 'DEBUG' # DEBUG, INFO, WARN, ERROR
  OIDC_PROVIDER_NAME: 'test-exploration-oidc'
  DISABLE_JOB_SUMMARY: false

permissions:
  actions: read # for detecting the Github Actions environment.
  id-token: write # for creating OIDC tokens for signing.
  packages: write # for uploading attestations.
  contents: write # to push updates while version bump and publish to repo, read is fine if there is just read operationâ€‹
  security-events: write # Required for uploading code scanning.
  issues: read

jobs:
  xray-nuget-audit:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout source code
      uses: actions/checkout@v3

    - name: Set up JFrog CLI
      uses: jfrog/setup-jfrog-cli@v4
      with:
        version: 2.72.2
        oidc-provider-name: ${{env.OIDC_PROVIDER_NAME}}
      env:
        JF_URL: ${{ env.JF_URL }}
        JF_ACCESS_TOKEN: ${{ secrets.JF_TK }}

    # - name: Configure the project's deployment repository
    #   run: |
    #     jf terraform-config --repo-deploy=${{env.RT_REPO_VIRTUAL}}

    - name: Install .NET 8.0 SDK
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Install Mono (for running nuget.exe)
      run: |
          sudo apt update
          sudo apt install -y mono-complete
  
    - name: Download NuGet CLI
      run: |
        mkdir -p $HOME/nuget
        wget -O $HOME/nuget/nuget.exe https://dist.nuget.org/win-x86-commandline/latest/nuget.exe
        echo "export PATH=$HOME/nuget:$PATH" >> $GITHUB_ENV

    - name: Check nuget.exe is in PATH
      run: which nuget.exe || echo "nuget.exe not found in PATH"

        
    - name: Restore NuGet packages
      run: |
          mono nuget.exe restore "gso-dynamics-plugin-main/MGMRI Sales/MGMRI Sales.sln"

    # - name: Xray Audit
    #   run: |
    #     sleep 120
    #     jf audit --format=table --extended-table=true --secrets=true --iac=true  --sca=true --sast=true --fail=false 

    - name: Run JFrog Xray Audit and Save Output
      continue-on-error: true
      run: |
        jf audit --nuget=true --format=table --extended-table=true \
        --secrets=true --sast=true --sca=true --licenses=true --fail=false \
        > xray-audit-report.txt

    - name: Upload Xray Audit Report
      uses: actions/upload-artifact@v4
      with:
        name: xray-audit-report
        path: xray-audit-report.txt


